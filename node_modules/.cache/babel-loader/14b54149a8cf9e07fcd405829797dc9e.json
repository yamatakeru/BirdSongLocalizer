{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\yamat\\\\Workspace\\\\hark_bird_app\\\\src\\\\components\\\\Main.js\";\nimport React, { useState, useEffect, createContext, useContext } from 'react';\nimport Konva from 'konva';\nimport useImage from 'use-image';\nimport { Stage, Layer, Star, Rect, Text, Image } from 'react-konva';\nimport request from \"superagent\";\nimport { UserCount } from '../App';\nimport Reset from './Reset';\n\nconst URLImage = props => {\n  const [image] = useImage(props.url);\n  return /*#__PURE__*/React.createElement(Image, {\n    image: image,\n    x: props.x,\n    y: props.y,\n    scaleX: props.scaleX,\n    scaleY: props.scaleY,\n    draggable: props.draggable,\n    dragBoundFunc: props.dragBoundFunc,\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 12,\n      columnNumber: 10\n    }\n  });\n};\n\nconst Main = () => {\n  const [count, setCount] = useContext(UserCount);\n  const [img_data, setImgData] = useState(null);\n  const [localized_data, setLocalizedData] = useState([]);\n  const [data_ia_loaded, setDataIsLoaded] = useState(false);\n  const [ldata_ia_loaded, setLDataIsLoaded] = useState(false);\n  const [ldata_is_selected, setLDataIsSelected] = useState(-1);\n  const [zoom_rate, setZoomRate] = useState(1.0);\n  const [img_pos_x, setImgPosX] = useState(10.0);\n\n  const getSpectrumImg = () => {\n    request.get(\"/api/getSpectrumImg\").end((err, data) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n\n      setImgData(data.body);\n      setDataIsLoaded(true);\n      return;\n    });\n  };\n\n  const getLocalizedData = () => {\n    request.get(\"/api/getLocalizedData\").end((err, data) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n\n      setLocalizedData(data.body.localized_data);\n      setLDataIsLoaded(true);\n      return;\n    });\n  };\n\n  const sendAnnotationData = () => {\n    request.post(\"/api/sendAnnotationData\").send(localized_data).end((err, res) => {\n      if (err) {\n        console.error(err);\n        return;\n      }\n\n      console.log(res.body.res);\n      return;\n    });\n  };\n\n  const updateLocalizedPos = e => {\n    const temp = localized_data.slice(0);\n    const idx = ldata_is_selected + 1;\n    temp[idx][2] = String((e.target.x() - img_pos_x) * (img_data.music.t_max / 992) / zoom_rate);\n    temp[idx][4] = String(-((e.target.y() + 10) / (740 / 2)) * 360 + 180);\n    setLocalizedData(temp);\n  };\n\n  const zoomStage = e => {\n    e.evt.preventDefault();\n    const next_zoom_rate = zoom_rate + e.evt.deltaY * -0.001;\n\n    if (next_zoom_rate < 1.0) {\n      next_zoom_rate = 1.0;\n    }\n\n    setZoomRate(next_zoom_rate);\n  };\n\n  const moveXImage = pos => {\n    const next_pos_x = pos.x; // pos.x < 10.0 ? 10.0 : pos.x;\n\n    setImgPosX(next_pos_x);\n    return {\n      \"x\": next_pos_x,\n      \"y\": 0\n    };\n  };\n\n  const playWav = idx => {\n    // ローカルファイル再生不可能問題のため未実装\n    console.log(\"play sep_\" + String(idx) + \".vaw.\");\n  };\n\n  const reset = () => {\n    setDataIsLoaded(false);\n    setLDataIsLoaded(false);\n    setLDataIsSelected(-1);\n    setZoomRate(1.0);\n    setImgPosX(10.0);\n  };\n\n  const button_area = () => {\n    if (data_ia_loaded) {\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"button_area\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 118,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(\"button\", {\n        onClick: () => getSpectrumImg(),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 119,\n          columnNumber: 11\n        }\n      }, \"Load Spectrum\"), /*#__PURE__*/React.createElement(\"button\", {\n        onClick: () => getLocalizedData(),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 122,\n          columnNumber: 11\n        }\n      }, \"Load Localized Sata\"), /*#__PURE__*/React.createElement(\"button\", {\n        onClick: () => sendAnnotationData(),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 125,\n          columnNumber: 11\n        }\n      }, \"Save Annotation Sata\"), /*#__PURE__*/React.createElement(\"button\", {\n        onClick: () => reset(),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 128,\n          columnNumber: 11\n        }\n      }, \"Resrt\"));\n    } else {\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"button_area\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 135,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(\"button\", {\n        onClick: () => getSpectrumImg(),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 136,\n          columnNumber: 11\n        }\n      }, \"load Spectrum\"));\n    }\n  };\n\n  const stage_area = () => {\n    if (data_ia_loaded) {\n      return /*#__PURE__*/React.createElement(\"div\", {\n        className: \"stage_area\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 147,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"Stage1\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 148,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 149,\n          columnNumber: 13\n        }\n      }, \"Specgram\"), /*#__PURE__*/React.createElement(Stage, {\n        width: window.innerWidth,\n        height: window.innerHeight / 4,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 150,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(Layer, {\n        onWheel: e => zoomStage(e),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 151,\n          columnNumber: 15\n        }\n      }, /*#__PURE__*/React.createElement(URLImage //url=\"https://raw.githubusercontent.com/yamatakeru/image_src/master/specgram.png\"\n      , {\n        url: img_data.specgram.img_path,\n        x: img_pos_x,\n        y: 0.0,\n        scaleX: zoom_rate,\n        scaleY: 0.5,\n        draggable: true,\n        dragBoundFunc: pos => moveXImage(pos),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 154,\n          columnNumber: 17\n        }\n      }), /*#__PURE__*/React.createElement(Text, {\n        text: \"specgram\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 164,\n          columnNumber: 17\n        }\n      })))), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"Stage2\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 168,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 169,\n          columnNumber: 11\n        }\n      }, \"Music\"), /*#__PURE__*/React.createElement(Stage, {\n        width: window.innerWidth,\n        height: window.innerHeight / 4,\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 170,\n          columnNumber: 11\n        }\n      }, /*#__PURE__*/React.createElement(Layer, {\n        onWheel: e => zoomStage(e),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 171,\n          columnNumber: 13\n        }\n      }, /*#__PURE__*/React.createElement(URLImage //url=\"https://raw.githubusercontent.com/yamatakeru/image_src/master/music.png\"\n      , {\n        url: img_data.music.img_path,\n        x: img_pos_x,\n        y: 0.0,\n        scaleX: zoom_rate,\n        scaleY: 0.5,\n        draggable: true,\n        dragBoundFunc: pos => moveXImage(pos),\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 174,\n          columnNumber: 15\n        }\n      }), /*#__PURE__*/React.createElement(Text, {\n        text: \"music\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 184,\n          columnNumber: 15\n        }\n      }), localized_data.slice(1).map(ld => {\n        return /*#__PURE__*/React.createElement(Rect, {\n          x: parseFloat(ld[2]) / img_data.music.t_max * 992 * zoom_rate + img_pos_x,\n          y: (-parseFloat(ld[4]) + 180) / 360 * (740 / 2) - 10,\n          draggable: true,\n          width: parseFloat(ld[3]) / img_data.music.t_max * 992 * zoom_rate,\n          height: 20,\n          fill: \"red\",\n          stroke: \"black\",\n          strokeWidth: 2,\n          opacity: 0.6,\n          onClick: () => setLDataIsSelected(parseInt(ld[0])),\n          onDragStart: () => setLDataIsSelected(parseInt(ld[0])),\n          onDragEnd: e => updateLocalizedPos(e),\n          onDblClick: () => playWav(parseInt(ld[0])),\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 187,\n            columnNumber: 19\n          }\n        });\n      })))));\n    } else {\n      return /*#__PURE__*/React.createElement(\"p\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 210,\n          columnNumber: 14\n        }\n      }, \"Please load spectrum data.\");\n    }\n  };\n\n  const localized_data_area = () => {\n    if (ldata_ia_loaded && ldata_is_selected >= 0) {\n      return /*#__PURE__*/React.createElement(\"dev\", {\n        className: \"localized_info\",\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 217,\n          columnNumber: 9\n        }\n      }, /*#__PURE__*/React.createElement(\"p\", {\n        __self: this,\n        __source: {\n          fileName: _jsxFileName,\n          lineNumber: 218,\n          columnNumber: 11\n        }\n      }, \"Localized Information\"), localized_data.slice(1)[ldata_is_selected].map(d => {\n        return /*#__PURE__*/React.createElement(\"ul\", {\n          __self: this,\n          __source: {\n            fileName: _jsxFileName,\n            lineNumber: 220,\n            columnNumber: 20\n          }\n        }, d);\n      }));\n    }\n\n    return;\n  };\n\n  return /*#__PURE__*/React.createElement(\"div\", {\n    className: \"Main\",\n    __self: this,\n    __source: {\n      fileName: _jsxFileName,\n      lineNumber: 230,\n      columnNumber: 5\n    }\n  }, button_area(), stage_area(), localized_data_area());\n};\n\nexport default Main;","map":{"version":3,"sources":["C:/Users/yamat/Workspace/hark_bird_app/src/components/Main.js"],"names":["React","useState","useEffect","createContext","useContext","Konva","useImage","Stage","Layer","Star","Rect","Text","Image","request","UserCount","Reset","URLImage","props","image","url","x","y","scaleX","scaleY","draggable","dragBoundFunc","Main","count","setCount","img_data","setImgData","localized_data","setLocalizedData","data_ia_loaded","setDataIsLoaded","ldata_ia_loaded","setLDataIsLoaded","ldata_is_selected","setLDataIsSelected","zoom_rate","setZoomRate","img_pos_x","setImgPosX","getSpectrumImg","get","end","err","data","console","error","body","getLocalizedData","sendAnnotationData","post","send","res","log","updateLocalizedPos","e","temp","slice","idx","String","target","music","t_max","zoomStage","evt","preventDefault","next_zoom_rate","deltaY","moveXImage","pos","next_pos_x","playWav","reset","button_area","stage_area","window","innerWidth","innerHeight","specgram","img_path","map","ld","parseFloat","parseInt","localized_data_area","d"],"mappings":"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","sourcesContent":["import React, { useState, useEffect, createContext, useContext } from 'react'\r\nimport Konva from 'konva';\r\nimport useImage from 'use-image';\r\nimport { Stage, Layer, Star, Rect, Text, Image } from 'react-konva';\r\nimport request from \"superagent\";\r\nimport { UserCount } from '../App';\r\nimport Reset from './Reset';\r\n\r\n\r\nconst URLImage = (props) => {\r\n  const [image] = useImage(props.url);\r\n  return <Image\r\n    image={image}\r\n    x={props.x}\r\n    y={props.y}\r\n    scaleX={props.scaleX}\r\n    scaleY={props.scaleY}\r\n    draggable={props.draggable}\r\n    dragBoundFunc={props.dragBoundFunc}\r\n  />;\r\n};\r\n\r\n\r\nconst Main = () => {\r\n  const [count, setCount] = useContext(UserCount);\r\n  const [img_data, setImgData] = useState(null);\r\n  const [localized_data, setLocalizedData] = useState([]);\r\n  const [data_ia_loaded, setDataIsLoaded] = useState(false);\r\n  const [ldata_ia_loaded, setLDataIsLoaded] = useState(false);\r\n  const [ldata_is_selected, setLDataIsSelected] = useState(-1);\r\n  const [zoom_rate, setZoomRate] = useState(1.0);\r\n  const [img_pos_x, setImgPosX] = useState(10.0)\r\n\r\n  const getSpectrumImg = () => {\r\n    request\r\n      .get(\"/api/getSpectrumImg\")\r\n      .end((err, data) => {\r\n        if (err) {\r\n          console.error(err);\r\n          return;\r\n        }\r\n          setImgData(data.body);\r\n          setDataIsLoaded(true);\r\n          return;\r\n      });\r\n  };\r\n\r\n  const getLocalizedData = () => {\r\n    request\r\n      .get(\"/api/getLocalizedData\")\r\n      .end((err, data) => {\r\n        if (err) {\r\n          console.error(err);\r\n          return;\r\n        }\r\n          setLocalizedData(data.body.localized_data);\r\n          setLDataIsLoaded(true);\r\n          return;\r\n      });\r\n  };\r\n\r\n  const sendAnnotationData = () => {\r\n    request\r\n    .post(\"/api/sendAnnotationData\")\r\n    .send(localized_data)\r\n    .end((err, res) => {\r\n      if (err) {\r\n        console.error(err);\r\n        return;\r\n      }\r\n        console.log(res.body.res);\r\n        return;\r\n    });\r\n  };\r\n\r\n  const updateLocalizedPos = (e) => {\r\n    const temp = localized_data.slice(0);\r\n    const idx = ldata_is_selected + 1;\r\n    \r\n    temp[idx][2] = String(((e.target.x() - img_pos_x) * (img_data.music.t_max / 992)) / zoom_rate);\r\n    temp[idx][4] = String((-((e.target.y() + 10) / (740 / 2))) * 360 + 180);\r\n    setLocalizedData(temp);\r\n  };\r\n\r\n  const zoomStage = (e) => {\r\n    e.evt.preventDefault();\r\n    const next_zoom_rate = zoom_rate + e.evt.deltaY * -0.001;\r\n    if (next_zoom_rate < 1.0) {\r\n      next_zoom_rate = 1.0;\r\n    }\r\n    setZoomRate(next_zoom_rate);\r\n  };\r\n\r\n  const moveXImage = (pos) => {\r\n    const next_pos_x = pos.x; // pos.x < 10.0 ? 10.0 : pos.x;\r\n\r\n    setImgPosX(next_pos_x)\r\n    return {\"x\": next_pos_x, \"y\": 0}\r\n  };\r\n\r\n  const playWav = (idx) => {\r\n    // ローカルファイル再生不可能問題のため未実装\r\n    console.log(\"play sep_\"+String(idx)+\".vaw.\");\r\n  };\r\n\r\n  const reset = () => {\r\n    setDataIsLoaded(false);\r\n    setLDataIsLoaded(false);\r\n    setLDataIsSelected(-1); \r\n    setZoomRate(1.0);\r\n    setImgPosX(10.0);\r\n\r\n  };\r\n\r\n  const button_area = () => {\r\n    if (data_ia_loaded) {\r\n      return (\r\n        <div className=\"button_area\">\r\n          <button onClick={() => getSpectrumImg()}>\r\n            Load Spectrum\r\n          </button>\r\n          <button onClick={() => getLocalizedData()}>\r\n            Load Localized Sata\r\n          </button>\r\n          <button onClick={() => sendAnnotationData()}>\r\n            Save Annotation Sata\r\n          </button>\r\n          <button onClick={() => reset()}>\r\n            Resrt\r\n          </button>\r\n      </div>\r\n      );\r\n    } else {\r\n      return (\r\n        <div className=\"button_area\">\r\n          <button onClick={() => getSpectrumImg()}>\r\n            load Spectrum\r\n          </button>\r\n        </div>\r\n      );\r\n    }\r\n  }\r\n\r\n  const stage_area = () => {\r\n    if (data_ia_loaded) {\r\n      return (\r\n        <div className=\"stage_area\">\r\n          <div className=\"Stage1\">\r\n            <p>Specgram</p>\r\n            <Stage width={window.innerWidth} height={window.innerHeight/4}>\r\n              <Layer\r\n                onWheel={e => zoomStage(e)}\r\n              >\r\n                <URLImage\r\n                  //url=\"https://raw.githubusercontent.com/yamatakeru/image_src/master/specgram.png\"\r\n                  url={img_data.specgram.img_path}\r\n                  x={img_pos_x}\r\n                  y={0.0}\r\n                  scaleX={zoom_rate}\r\n                  scaleY={0.5}\r\n                  draggable={true}\r\n                  dragBoundFunc={(pos) => moveXImage(pos)}\r\n                />\r\n                <Text text=\"specgram\" />\r\n              </Layer>\r\n            </Stage>\r\n          </div>\r\n          <div className=\"Stage2\">\r\n          <p>Music</p>\r\n          <Stage width={window.innerWidth} height={window.innerHeight/4}>\r\n            <Layer\r\n              onWheel={e => zoomStage(e)}\r\n            >\r\n              <URLImage\r\n                //url=\"https://raw.githubusercontent.com/yamatakeru/image_src/master/music.png\"\r\n                url={img_data.music.img_path}\r\n                x={img_pos_x}\r\n                y={0.0}\r\n                scaleX={zoom_rate}\r\n                scaleY={0.5}\r\n                draggable={true}\r\n                dragBoundFunc={(pos) => moveXImage(pos)}\r\n              />\r\n              <Text text=\"music\" />\r\n              {localized_data.slice(1).map(ld => {\r\n                return (\r\n                  <Rect\r\n                    x={(((parseFloat(ld[2]) / img_data.music.t_max) * 992) * zoom_rate) + img_pos_x}\r\n                    y={((-parseFloat(ld[4]) + 180) / 360) * (740 / 2) - 10}\r\n                    draggable={true}\r\n                    width={((parseFloat(ld[3]) / img_data.music.t_max) * 992) * zoom_rate}\r\n                    height={20}\r\n                    fill=\"red\"\r\n                    stroke='black'\r\n                    strokeWidth={2}\r\n                    opacity={0.6}\r\n                    onClick={() => setLDataIsSelected(parseInt(ld[0]))}\r\n                    onDragStart={() => setLDataIsSelected(parseInt(ld[0]))}\r\n                    onDragEnd={e =>updateLocalizedPos(e)}\r\n                    onDblClick={() => playWav(parseInt(ld[0]))}\r\n                  />\r\n                )})\r\n              }\r\n            </Layer>\r\n          </Stage>\r\n        </div>\r\n      </div>\r\n      );\r\n    } else {\r\n      return <p>Please load spectrum data.</p>;\r\n    }\r\n  };\r\n\r\n  const localized_data_area = () => {\r\n    if (ldata_ia_loaded && ldata_is_selected >= 0) {\r\n      return (\r\n        <dev className=\"localized_info\">\r\n          <p>Localized Information</p>\r\n          {localized_data.slice(1)[ldata_is_selected].map(d => {\r\n            return <ul>{d}</ul>\r\n            })\r\n          }\r\n        </dev>\r\n      );\r\n    }\r\n    return;\r\n  };\r\n\r\n  return (\r\n    <div className=\"Main\">\r\n      {button_area()}\r\n      {stage_area()}\r\n      {localized_data_area()}\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default Main;\r\n"]},"metadata":{},"sourceType":"module"}